name: CI

on:
    # Run on every push to any branch
    push:
        branches: ["*"]
    pull_request:
        branches: ["*"]
    workflow_dispatch:
        inputs:
            pr_number:
                description: "PR number to run CI for (leave empty for current branch)"
                required: false
                type: string
            environment:
                description: "Environment to build (development, canary, production)"
                required: false
                default: "development"
                type: choice
                options:
                    - development
                    - canary
                    - production

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint-and-type-check:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        # Always run on workflow_dispatch and pull_request; skip push only if [skip-push-ci]
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request' || !contains(github.event.head_commit.message, '[skip-push-ci]')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.pr_number && format('refs/pull/{0}/head', github.event.inputs.pr_number) || github.ref }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Lint (ESLint)
              run: yarn lint

            - name: Format Check (Prettier)
              run: yarn format:check

            - name: Type check
              run: yarn type-check

    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: [lint-and-type-check]
        # Always run on workflow_dispatch and pull_request; skip push only if [skip-push-ci]
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request' || !contains(github.event.head_commit.message, '[skip-push-ci]')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.pr_number && format('refs/pull/{0}/head', github.event.inputs.pr_number) || github.ref }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Run unit tests with coverage
              run: yarn test:coverage

            - name: Upload coverage reports
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 7

    build:
        name: Build Extension
        runs-on: ubuntu-latest
        needs: [lint-and-type-check]
        # Always run on workflow_dispatch; on PR always run; on push only main/develop and not [skip-push-ci]
        if: |
            github.event_name == 'workflow_dispatch' ||
            github.event_name == 'pull_request' ||
            (github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'develop') && !contains(github.event.head_commit.message, '[skip-push-ci]'))
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.pr_number && format('refs/pull/{0}/head', github.event.inputs.pr_number) || github.ref }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Determine Environment
              id: env
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "val=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "main" ]; then
                    echo "val=production" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "develop" ]; then
                    echo "val=canary" >> $GITHUB_OUTPUT
                  else
                    echo "val=development" >> $GITHUB_OUTPUT
                  fi

            - name: Build and Package extension
              env:
                  CI_COVERAGE: "true"
                  EXTENSION_ENV: ${{ steps.env.outputs.val }}
              run: yarn package

            - name: "Debug: List build artifacts"
              run: ls -R build-output/

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: extension-build-${{ steps.env.outputs.val }}
                  path: build-output/
                  retention-days: 7

    package:
        name: Package Extension
        runs-on: ubuntu-latest
        needs: [build]
        # Always run on workflow_dispatch; on push only main/develop and not [skip-push-ci]
        if: |
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'develop') && !contains(github.event.head_commit.message, '[skip-push-ci]'))
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.pr_number && format('refs/pull/{0}/head', github.event.inputs.pr_number) || github.ref }}

            - name: Determine Environment
              id: env
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "val=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "main" ]; then
                    echo "val=production" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "develop" ]; then
                    echo "val=canary" >> $GITHUB_OUTPUT
                  else
                    echo "val=development" >> $GITHUB_OUTPUT
                  fi

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Package extension
              env:
                  EXTENSION_ENV: ${{ steps.env.outputs.val }}
              run: yarn package

            - name: Upload package artifact
              uses: actions/upload-artifact@v4
              with:
                  name: extension-package-${{ steps.env.outputs.val }}
                  path: build-output/*.zip
                  retention-days: 7

    test-e2e:
        name: E2E Tests
        runs-on: ubuntu-latest
        needs: [build]
        # Always run on workflow_dispatch; on PR always run; on push only main/develop and not [skip-push-ci]
        if: |
            github.event_name == 'workflow_dispatch' ||
            github.event_name == 'pull_request' ||
            (github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'develop') && !contains(github.event.head_commit.message, '[skip-push-ci]'))
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.pr_number && format('refs/pull/{0}/head', github.event.inputs.pr_number) || github.ref }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Cache Playwright browsers
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-playwright-

            - name: Install Playwright browsers
              run: yarn playwright install --with-deps chromium

            - name: Determine Environment
              id: env
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "val=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "main" ]; then
                    echo "val=production" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "develop" ]; then
                    echo "val=canary" >> $GITHUB_OUTPUT
                  else
                    echo "val=development" >> $GITHUB_OUTPUT
                  fi

            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: extension-build-${{ steps.env.outputs.val }}
                  path: build-output/

            - name: "Debug: Verify downloaded artifacts"
              run: ls -R build-output/

            - name: Run E2E tests
              env:
                  CI_COVERAGE: "true"
              run: yarn test:e2e

            - name: Generate Playwright coverage report
              if: always()
              run: yarn coverage:playwright

            - name: Upload E2E coverage
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-coverage
                  path: coverage/playwright/
                  retention-days: 7

    coverage-badges:
        name: Generate Coverage Badges
        runs-on: ubuntu-latest
        needs: [test, test-e2e]
        # Always run on workflow_dispatch and pull_request; skip push if [skip-push-ci] or release commit
        if: |
            github.event_name == 'workflow_dispatch' ||
            github.event_name == 'pull_request' ||
            (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip-push-ci]') && !startsWith(github.event.head_commit.message, 'chore(release):'))
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  ref: ${{ github.event.inputs.pr_number && format('refs/pull/{0}/head', github.event.inputs.pr_number) || github.ref }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Download Vitest coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/

            - name: Download Playwright coverage
              uses: actions/download-artifact@v4
              with:
                  name: playwright-coverage
                  path: coverage/playwright/

            - name: Debug coverage files
              run: |
                  echo "=== Coverage directory structure ==="
                  find coverage -type f -name "*.json" 2>/dev/null || echo "No JSON files found"
                  echo ""
                  echo "=== Vitest coverage summary ==="
                  if [ -f "coverage/vitest/coverage-summary.json" ]; then
                    cat coverage/vitest/coverage-summary.json | head -5
                  else
                    echo "ERROR: coverage/vitest/coverage-summary.json not found!"
                    ls -la coverage/ 2>/dev/null || echo "coverage/ directory does not exist"
                  fi
                  echo ""
                  echo "=== Playwright coverage summary ==="
                  if [ -f "coverage/playwright/coverage-summary.json" ]; then
                    cat coverage/playwright/coverage-summary.json | head -5
                  else
                    echo "WARNING: coverage/playwright/coverage-summary.json not found"
                    ls -la coverage/playwright/ 2>/dev/null || echo "coverage/playwright/ directory does not exist"
                  fi

            - name: Generate coverage badges
              run: yarn coverage:badges

            - name: Commit and push coverage badges
              if: github.event_name == 'push' && github.ref_type == 'branch'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"

                  # Update branch name in README.md links
                  perl -pi -e "s|/agnostic-devkit/.*?/.badges/|/agnostic-devkit/${{ github.ref_name }}/.badges/|g" README.md
                  perl -pi -e "s|badge.svg\?branch=.*?([\) ])|badge.svg?branch=${{ github.ref_name }}\$1|g" README.md

                  git add .badges/ README.md
                  if ! git diff --staged --quiet; then
                    git commit -m "chore: update coverage badges for ${{ github.ref_name }} [skip-push-ci]"
                    # Discard any other unstaged changes (e.g. yarn.lock) to ensure a clean rebase
                    git checkout .
                    git pull --rebase origin ${{ github.ref_name }}
                    git push origin ${{ github.ref_name }}
                  fi
