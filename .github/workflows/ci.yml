name: CI

on:
    # Run on every push to any branch
    push:
        branches: ["*"]
    pull_request:
        branches: ["*"]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint-and-type-check:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Lint (Oxlint)
              run: yarn lint

            - name: Format Check (Biome)
              run: yarn check

            - name: Type check
              run: yarn type-check

    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: [lint-and-type-check]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Run unit tests with coverage
              run: yarn test:coverage

            - name: Upload coverage reports
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 7

    build:
        name: Build Extension
        runs-on: ubuntu-latest
        needs: [lint-and-type-check]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Build extension (for E2E with coverage)
              env:
                  CI_COVERAGE: "true"
              run: yarn build:all

            - name: "Debug: List build artifacts"
              run: ls -R build-output/

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: extension-build
                  path: build-output/
                  retention-days: 7

    test-e2e:
        name: E2E Tests
        runs-on: ubuntu-latest
        needs: [build]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Cache Playwright browsers
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-playwright-

            - name: Install Playwright browsers
              run: yarn playwright install --with-deps chromium

            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: extension-build
                  path: build-output/

            - name: "Debug: Verify downloaded artifacts"
              run: ls -R build-output/

            - name: Run E2E tests
              env:
                  CI_COVERAGE: "true"
              run: yarn test:e2e

            - name: Generate Playwright coverage report
              if: always()
              run: yarn coverage:playwright

            - name: Upload E2E coverage
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-coverage
                  path: coverage/playwright/
                  retention-days: 7

    coverage-badges:
        name: Generate Coverage Badges
        runs-on: ubuntu-latest
        needs: [test, test-e2e]
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Download Vitest coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/

            - name: Download Playwright coverage
              uses: actions/download-artifact@v4
              with:
                  name: playwright-coverage
                  path: coverage/playwright/

            - name: Debug coverage files
              run: |
                  echo "=== Coverage directory structure ==="
                  find coverage -type f -name "*.json" 2>/dev/null || echo "No JSON files found"
                  echo ""
                  echo "=== Vitest coverage summary ==="
                  if [ -f "coverage/vitest/coverage-summary.json" ]; then
                    cat coverage/vitest/coverage-summary.json | head -5
                  else
                    echo "ERROR: coverage/vitest/coverage-summary.json not found!"
                    ls -la coverage/ 2>/dev/null || echo "coverage/ directory does not exist"
                  fi
                  echo ""
                  echo "=== Playwright coverage summary ==="
                  if [ -f "coverage/playwright/coverage-summary.json" ]; then
                    cat coverage/playwright/coverage-summary.json | head -5
                  else
                    echo "WARNING: coverage/playwright/coverage-summary.json not found"
                    ls -la coverage/playwright/ 2>/dev/null || echo "coverage/playwright/ directory does not exist"
                  fi

            - name: Generate coverage badges
              run: yarn coverage:badges

            - name: Commit coverage badges
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add .badges/
                  git diff --staged --quiet || git commit -m "chore: update coverage badges [skip ci]"
                  git pull --rebase origin main
                  git push
