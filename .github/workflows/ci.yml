name: CI

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:
    inputs:
      profiles:
        description: "Build profiles (comma-separated: development, canary, production)"
        required: false
        default: "canary,production"
        type: string
      run_release:
        description: "Run semantic-release"
        required: false
        default: true
        type: boolean
      dry_run:
        description: "Dry run mode (skip push/upload operations, for local testing with act)"
        required: false
        default: false
        type: boolean

env:
  # Detect dry run mode: explicit input OR running locally with act
  IS_DRY_RUN: ${{ github.event.inputs.dry_run == 'true' || github.event.inputs.dry_run == true }}

jobs:
  # Setup job determines build profiles and skip conditions
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      profiles: ${{ steps.profiles.outputs.json }}
      should_skip: ${{ steps.skip.outputs.should_skip }}
      is_release_branch: ${{ steps.check.outputs.is_release_branch }}
      is_dry_run: ${{ steps.check.outputs.is_dry_run }}
    steps:
      - name: Check conditions
        id: check
        run: |
          # Check if this is a release branch
          if [ "${{ github.ref_name }}" == "main" ] || [ "${{ github.ref_name }}" == "develop" ]; then
            echo "is_release_branch=true" >> $GITHUB_OUTPUT
          else
            echo "is_release_branch=false" >> $GITHUB_OUTPUT
          fi

          # Check dry run mode
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "is_dry_run=true" >> $GITHUB_OUTPUT
          else
            echo "is_dry_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Check skip conditions
        id: skip
        run: |
          # Skip if this is a release commit (prevents infinite loops)
          if [[ "${{ github.event.head_commit.message }}" == chore\(release\):* ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "Skipping: release commit detected"
          # Skip if [skip ci] in commit message on push
          elif [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.event.head_commit.message }}" == *"[skip ci]"* ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "Skipping: [skip ci] in commit message"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine build profiles
        id: profiles
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Parse comma-separated input into JSON array (compact, single-line output)
            input="${{ github.event.inputs.profiles }}"
            profiles=$(echo "$input" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$' | jq -R . | jq -sc .)
            echo "json=$profiles" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" == "main" ]; then
            echo 'json=["production"]' >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" == "develop" ]; then
            echo 'json=["canary"]' >> $GITHUB_OUTPUT
          else
            echo 'json=["development"]' >> $GITHUB_OUTPUT
          fi

  lint-and-type-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: [setup]
    if: needs.setup.outputs.should_skip != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "25.0.0"

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Yarn
        run: corepack prepare yarn@4.10.3 --activate

      - name: Get Yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint (ESLint)
        run: yarn lint

      - name: Format Check (Prettier)
        run: yarn format:check

      - name: Type check
        run: yarn type-check

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [setup, lint-and-type-check]
    if: needs.setup.outputs.should_skip != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "25.0.0"

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Yarn
        run: corepack prepare yarn@4.10.3 --activate

      - name: Get Yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run unit tests with coverage
        run: yarn test:coverage

      - name: Upload coverage reports
        if: env.IS_DRY_RUN != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  build:
    name: Build (${{ matrix.profile }})
    runs-on: ubuntu-latest
    needs: [setup, lint-and-type-check]
    if: needs.setup.outputs.should_skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        profile: ${{ fromJson(needs.setup.outputs.profiles) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "25.0.0"

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Yarn
        run: corepack prepare yarn@4.10.3 --activate

      - name: Get Yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build and Package extension
        env:
          CI_COVERAGE: "true"
          EXTENSION_ENV: ${{ matrix.profile }}
        run: yarn package

      - name: Upload build artifact
        if: env.IS_DRY_RUN != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: extension-build-${{ matrix.profile }}
          path: build-output/
          retention-days: 7

  test-e2e:
    name: E2E Tests (${{ matrix.profile }})
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.should_skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        profile: ${{ fromJson(needs.setup.outputs.profiles) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "25.0.0"

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Yarn
        run: corepack prepare yarn@4.10.3 --activate

      - name: Get Yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: yarn playwright install --with-deps chromium

      - name: Download build artifact
        if: env.IS_DRY_RUN != 'true'
        uses: actions/download-artifact@v4
        with:
          name: extension-build-${{ matrix.profile }}
          path: build-output/

      - name: Build extension (dry run mode)
        if: env.IS_DRY_RUN == 'true'
        env:
          EXTENSION_ENV: ${{ matrix.profile }}
        run: yarn package

      - name: Run E2E tests
        env:
          CI_COVERAGE: "true"
        run: yarn test:e2e

      - name: Generate Playwright coverage report
        if: always()
        run: yarn coverage:playwright

      - name: Upload E2E coverage
        if: env.IS_DRY_RUN != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-coverage-${{ matrix.profile }}
          path: coverage/playwright/
          retention-days: 7

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [setup, test, test-e2e]
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: false
    if: |
      needs.setup.outputs.should_skip != 'true' &&
      needs.setup.outputs.is_release_branch == 'true' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_release == 'true'))
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: true
          ref: ${{ github.ref_name }}

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "25.0.0"

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Yarn
        run: corepack prepare yarn@4.10.3 --activate

      - name: Get Yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "val=production" >> $GITHUB_OUTPUT
          else
            echo "val=canary" >> $GITHUB_OUTPUT
          fi

      - name: Semantic Release
        id: semantic
        if: env.IS_DRY_RUN != 'true'
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          EXTENSION_ENV: ${{ steps.env.outputs.val }}
        run: |
          npx semantic-release | tee semantic.log

          if grep -q "Published release" semantic.log || grep -q "Published prerelease" semantic.log; then
            echo "new_release_published=true" >> $GITHUB_OUTPUT
          else
            echo "new_release_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Semantic Release (Dry Run)
        if: env.IS_DRY_RUN == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXTENSION_ENV: ${{ steps.env.outputs.val }}
        run: |
          echo "DRY RUN: Would run semantic-release here"
          npx semantic-release --dry-run || true

  pr-comment:
    name: Post PR Summary
    runs-on: ubuntu-latest
    needs: [setup, build, test, test-e2e]
    if: |
      needs.setup.outputs.should_skip != 'true' &&
      github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Post PR summary comment
        if: env.IS_DRY_RUN != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runId = context.runId;

            // Get artifacts from this run
            const { data: { artifacts } } = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId
            });

            // Filter artifacts by type
            const buildArtifacts = artifacts.filter(a => a.name.startsWith('extension-build-'));
            const coverageArtifact = artifacts.find(a => a.name === 'coverage-report');
            const playwrightCoverageArtifacts = artifacts.filter(a => a.name.startsWith('playwright-coverage-'));

            // Build comment body
            let body = '## CI Summary\n\n';

            // Coverage section
            body += '### Coverage Reports\n\n';
            body += '| Type | Download |\n';
            body += '|------|----------|\n';

            if (coverageArtifact) {
              const url = `https://github.com/${owner}/${repo}/actions/runs/${runId}/artifacts/${coverageArtifact.id}`;
              body += `| Unit Tests | [Download](${url}) |\n`;
            }

            for (const artifact of playwrightCoverageArtifacts) {
              const profile = artifact.name.replace('playwright-coverage-', '');
              const url = `https://github.com/${owner}/${repo}/actions/runs/${runId}/artifacts/${artifact.id}`;
              body += `| E2E Tests (${profile}) | [Download](${url}) |\n`;
            }

            // Build artifacts section
            if (buildArtifacts.length > 0) {
              body += '\n### Build Artifacts\n\n';
              body += '| Profile | Download |\n';
              body += '|---------|----------|\n';
              
              for (const artifact of buildArtifacts) {
                const profile = artifact.name.replace('extension-build-', '');
                const url = `https://github.com/${owner}/${repo}/actions/runs/${runId}/artifacts/${artifact.id}`;
                body += `| ${profile} | [Download](${url}) |\n`;
              }
            }

            body += '\n> Note: Artifacts expire after 7 days.';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('## CI Summary')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body
              });
            }
