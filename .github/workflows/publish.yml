name: Release & Publish

on:
    push:
        branches:
            - main
            - develop
    workflow_dispatch:
        inputs:
            dry-run:
                description: "Dry run"
                required: false
                default: false
                type: boolean

jobs:
    release:
        name: Semantic Release
        runs-on: ubuntu-latest
        # Always run on workflow_dispatch; skip push if release commit (prevents infinite loop)
        if: github.event_name == 'workflow_dispatch' || !startsWith(github.event.head_commit.message, 'chore(release):')
        permissions:
            contents: write
            issues: write
            pull-requests: write
        outputs:
            new_release_published: ${{ steps.semantic.outputs.new_release_published }}
            new_release_version: ${{ steps.semantic.outputs.new_release_version }}
        steps:
            - name: Generate App Token
              id: app-token
              uses: actions/create-github-app-token@v1
              with:
                  app-id: ${{ secrets.APP_ID }}
                  private-key: ${{ secrets.APP_PRIVATE_KEY }}

            - name: Determine Environment
              id: env
              run: |
                  if [ "${{ github.ref_name }}" == "main" ]; then
                    echo "val=production" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "develop" ]; then
                    echo "val=canary" >> $GITHUB_OUTPUT
                  else
                    echo "val=development" >> $GITHUB_OUTPUT
                  fi

            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ steps.app-token.outputs.token }}
                  persist-credentials: true
                  ref: ${{ github.ref_name }}

            - name: Fetch all tags
              run: git fetch --tags --force

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Lint (ESLint)
              run: yarn lint

            - name: Format Check (Prettier)
              run: yarn format:check

            - name: Type Check
              run: yarn type-check

            - name: Semantic Release
              id: semantic
              env:
                  GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
                  EXTENSION_ENV: ${{ steps.env.outputs.val }}
              run: |
                  # Run semantic-release and capture its output
                  # Use --debug to get more info if needed
                  npx semantic-release | tee semantic.log
                  
                  # Check if a new release was published
                  if grep -q "Published release" semantic.log || grep -q "Published prerelease" semantic.log; then
                    echo "new_release_published=true" >> $GITHUB_OUTPUT
                  else
                    echo "new_release_published=false" >> $GITHUB_OUTPUT
                  fi

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: release
        if: needs.release.outputs.new_release_published == 'true'
        steps:
            - uses: actions/checkout@v4

            - name: Determine Environment
              id: env
              run: |
                  if [ "${{ github.ref_name }}" == "main" ]; then
                    echo "val=production" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "develop" ]; then
                    echo "val=canary" >> $GITHUB_OUTPUT
                  else
                    echo "val=development" >> $GITHUB_OUTPUT
                  fi

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Build and Package
              env:
                  EXTENSION_ENV: ${{ steps.env.outputs.val }}
              run: yarn package

            - name: "Debug: List build artifacts"
              run: ls -R build-output/

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: build-${{ steps.env.outputs.val }}
                  path: build-output/

    test:
        name: Test
        runs-on: ubuntu-latest
        needs: build
        steps:
            - uses: actions/checkout@v4

            - name: Determine Environment
              id: env
              run: |
                  if [ "${{ github.ref_name }}" == "main" ]; then
                    echo "val=production" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "develop" ]; then
                    echo "val=canary" >> $GITHUB_OUTPUT
                  else
                    echo "val=development" >> $GITHUB_OUTPUT
                  fi

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Cache Playwright browsers
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-playwright-

            - name: Install Playwright
              run: yarn playwright install --with-deps chromium

            - name: Build and Package
              env:
                  EXTENSION_ENV: ${{ steps.env.outputs.val }}
              run: yarn package

            - name: Test (Unit/Integration)
              run: yarn test

            - name: Test (E2E)
              run: yarn test:e2e

    package:
        name: Package
        runs-on: ubuntu-latest
        needs: [build, test]
        steps:
            - uses: actions/checkout@v4

            - name: Determine Environment
              id: env
              run: |
                  if [ "${{ github.ref_name }}" == "main" ]; then
                    echo "val=production" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_name }}" == "develop" ]; then
                    echo "val=canary" >> $GITHUB_OUTPUT
                  else
                    echo "val=development" >> $GITHUB_OUTPUT
                  fi

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Package
              env:
                  EXTENSION_ENV: ${{ steps.env.outputs.val }}
              run: yarn package

            - name: Sync main to develop
              if: github.ref_name == 'main' && needs.release.outputs.new_release_published == 'true'
              env:
                  GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  
                  # Fetch develop to ensure we have it
                  git fetch origin develop
                  
                  # Switch to develop and merge main
                  git checkout develop
                  git merge main --no-edit
                  
                  # Push back to develop, skipping CI
                  git push origin develop --no-verify -o ci.skip

            - name: Upload package artifact
              uses: actions/upload-artifact@v4
              with:
                  name: extension-package-${{ steps.env.outputs.val }}
                  path: build-output/*.zip
