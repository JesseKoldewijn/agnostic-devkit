name: Release & Publish

on:
    push:
        branches:
            - main
    workflow_dispatch:
        inputs:
            dry-run:
                description: "Dry run"
                required: false
                default: false
                type: boolean

jobs:
    release:
        name: Semantic Release
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: write
            pull-requests: write
        outputs:
            new_release_published: ${{ steps.semantic.outputs.new_release_published }}
            new_release_version: ${{ steps.semantic.outputs.new_release_version }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: false

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Semantic Release
              id: semantic
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: npx semantic-release

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: release
        if: needs.release.outputs.new_release_published == 'true'
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: main

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Build
              run: yarn build

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: build
                  path: dist/

    test:
        name: Test
        runs-on: ubuntu-latest
        needs: build
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: main

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Cache Playwright browsers
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-playwright-

            - name: Install Playwright
              run: yarn playwright install --with-deps chromium

            - name: Build
              run: yarn build

            - name: Test (Unit/Integration)
              run: yarn test

            - name: Test (E2E)
              run: yarn test:e2e

    package:
        name: Package
        runs-on: ubuntu-latest
        needs: [build, test]
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: main

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Build
              run: yarn build

            - name: Package
              run: yarn package

            - name: Upload package artifact
              uses: actions/upload-artifact@v4
              with:
                  name: extension-package
                  path: dist/*.zip

    upload:
        name: Upload to Chrome Web Store
        runs-on: ubuntu-latest
        needs: [build, test, package]
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: main

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25.0.0"

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Yarn
              run: corepack prepare yarn@4.10.3 --activate

            - name: Get Yarn cache directory path
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Build
              run: yarn build

            - name: Package
              run: yarn package

            - name: Upload & release
              uses: mnao305/chrome-extension-upload@v5.0.0
              with:
                  file-path: dist/*.zip
                  extension-id: ${{ secrets.EXTENSION_ID }}
                  client-id: ${{ secrets.CLIENT_ID }}
                  client-secret: ${{ secrets.CLIENT_SECRET }}
                  refresh-token: ${{ secrets.REFRESH_TOKEN }}
                  glob: true
                  dry-run: ${{ inputs.dry-run }}
